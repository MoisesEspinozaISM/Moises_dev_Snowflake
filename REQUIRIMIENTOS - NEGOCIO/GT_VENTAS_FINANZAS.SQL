
 --////////////////// caso m ///////////////////// FACUTRAS DE VENTA 
 WITH base AS (
    SELECT
        VBRK.VBELN,
        VBRK.KNUMV,
        VBRP.POSNR,
        VBRP.VGBEL,
        VBRP.VGPOS,
        VBRP.MATNR
    FROM SAPPRD.VBRK VBRK
    INNER JOIN SAPPRD.VBRP VBRP
        ON VBRK.VBELN = VBRP.VBELN
    WHERE VBRK.LAND1 IN ('GT')
),
mseg_1 AS (
    SELECT VBELN_IM, VBELP_IM, MATNR, BWART, SAKTO
    FROM (
        SELECT
            m.VBELN_IM,
            m.VBELP_IM,
            m.MATNR,
            m.BWART,
            m.SAKTO,
            m.MBLNR,
            ROW_NUMBER() OVER (
                PARTITION BY m.VBELN_IM, m.VBELP_IM, m.MATNR
                ORDER BY m.MBLNR DESC
            ) AS rn
        FROM SAPPRD.MSEG m
        INNER JOIN (
            SELECT DISTINCT VGBEL, VGPOS, MATNR
            FROM base
        ) b
            ON b.VGBEL = m.VBELN_IM
           AND b.VGPOS = m.VBELP_IM
           AND b.MATNR = m.MATNR
        WHERE m.MBLNR IS NOT NULL
    ) x
    WHERE rn = 1
)
SELECT 
Z.SERIE AS SERIE, 
Z.NUMERO AS NUMERO ,
Z.UUID AS UUID ,
Z.FECHA AS FECHA ,
M.BWART AS CLASE_MOV ,
M.SAKTO AS CUENTA_COSTO 
FROM base b
LEFT JOIN SAPPRD.KONV KONV_1
    ON KONV_1."KNUMV" = b.KNUMV
   AND KONV_1."KPOSN" = b.POSNR
   AND KONV_1."KSCHL" = 'ZPRE'
   AND KONV_1."KINAK" = 'NA'
LEFT JOIN SAPPRD.KONV KONV_2
    ON KONV_2."KNUMV" = b.KNUMV
   AND KONV_2."KPOSN" = b.POSNR
   AND KONV_2."KSCHL" = 'PB00'
   AND KONV_2."KINAK" = 'NA'
LEFT JOIN SAPPRD.ZFEL_RESULT z
    ON z.VBELN = b.VBELN
LEFT JOIN mseg_1 m
    ON m.VBELN_IM = b.VGBEL
   AND m.VBELP_IM = b.VGPOS
   AND m.MATNR    = b.MATNR
WHERE b.VBELN  = '0952035776';

-- AGREGANDO CASO M 
; 
SELECT * FROM "DEV_GOLD_M"."COMERCIAL"."GOLD_VENTAS_SAP_FINANCIERO_GT"
WHERE ID_FACTURA = '0951991805'
; 
SELECT * FROM "DEV_GOLD_M"."COMERCIAL"."GOLD_VENTAS_SAP_FINANCIERO_GT"
WHERE ID_FACTURA = '0951992229'
; 


/* VERSION FINAL DE REPORTE FINANCIOERO DE GR  */
SELECT
COUNT(*)
    /* Resultado final: primero M (directo), luego N (ruta Z007), luego NA */
    -- COALESCE(MSEG_M."SAKTO", MSEG_N."SAKTO", 'NA') AS "SAKTO_FINAL",
    -- COALESCE(MSEG_M."BWART", MSEG_N."BWART", 'NA') AS "BWART_FINAL",
FROM "DEV_SILVER_M"."COMERCIAL"."SILVER_VENTAS_SAP" AS "SILVER_VENTAS_SAP"
/* KONV: ZPRE */
LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_KONV" AS "STM_KONV_ZPRE"
  ON "STM_KONV_ZPRE"."KNUMV" = "SILVER_VENTAS_SAP"."NUMERO_DE_CONDICION"
 AND "STM_KONV_ZPRE"."KPOSN" = "SILVER_VENTAS_SAP"."POSICION"
 AND "STM_KONV_ZPRE"."MANDT" = "SILVER_VENTAS_SAP"."MANDANTE"
 AND "STM_KONV_ZPRE"."KSCHL" = 'ZPRE'
 AND "STM_KONV_ZPRE"."KINAK" = 'NA'
/* KONV: PB00 */
LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_KONV" AS "STM_KONV_PB00"
  ON "STM_KONV_PB00"."KNUMV" = "SILVER_VENTAS_SAP"."NUMERO_DE_CONDICION"
 AND "STM_KONV_PB00"."KPOSN" = "SILVER_VENTAS_SAP"."POSICION"
 AND "STM_KONV_PB00"."MANDT" = "SILVER_VENTAS_SAP"."MANDANTE"
 AND "STM_KONV_PB00"."KSCHL" = 'PB00'
 AND "STM_KONV_PB00"."KINAK" = 'NA'
/* ZFEL_RESULT */
LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_ZFEL_RESULT" AS "STM_ZFEL_RESULT"
  ON "STM_ZFEL_RESULT"."VBELN" = "SILVER_VENTAS_SAP"."ID_FACTURA"

/* =========================
   MSEG_M (CASO M) - DIRECTO
   ========================= */
LEFT JOIN (
    SELECT
        "VBELN_IM",
        "VBELP_IM",
        "MATNR",
        "BWART",
        "SAKTO",
        "MBLNR"
    FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_MSEG"
    WHERE "MBLNR" IS NOT NULL
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY "VBELN_IM", "VBELP_IM", "MATNR"
        ORDER BY "MBLNR" DESC
    ) = 1
) AS MSEG_M
  ON MSEG_M."VBELN_IM" = "SILVER_VENTAS_SAP"."ID_ENTREGA"
 AND MSEG_M."VBELP_IM" = "SILVER_VENTAS_SAP"."VGPOS"
 AND MSEG_M."MATNR"     = "SILVER_VENTAS_SAP"."ID_SKU_ORIGEN"

/* ==========================================
   RUTA N (VBAK1 -> VBAK2(Z007) -> LIPS -> MSEG)
   ========================================== */
/* VBAP_1: asegurar que existe el item (por si hay ceros a la izquierda) */
LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBAP" AS "VBAP_1"
  ON "VBAP_1"."VBELN" = "SILVER_VENTAS_SAP"."ID_ENTREGA"
 AND "VBAP_1"."POSNR" = "SILVER_VENTAS_SAP"."VGPOS"
 AND "VBAP_1"."MATNR" = "SILVER_VENTAS_SAP"."ID_SKU_ORIGEN" 

-- /* VBAK_1: para obtener BSTNK */
LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBAK" AS "VBAK_1"
  ON "VBAK_1"."VBELN" = "VBAP_1"."VBELN"
 AND "VBAK_1"."VKORG" = "SILVER_VENTAS_SAP"."VKORG" 

/* VBAK_2 (Z007): tomar 1 pedido (el MAYOR) por VKORG+BSTNK+MATNR */
LEFT JOIN (
    SELECT
        v2."VKORG",
        v2."BSTNK",
        p2."MATNR",
        v2."VBELN" AS "VBELN_Z007"
    FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBAK" v2
    JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBAP" p2
      ON p2."VBELN" = v2."VBELN"
    WHERE v2."AUART" = 'Z007'
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY v2."VKORG", v2."BSTNK", p2."MATNR"
        ORDER BY v2."VBELN" DESC
    ) = 1
) AS "VBAK_2"
  ON "VBAK_2"."VKORG" = "SILVER_VENTAS_SAP"."VKORG"
 AND "VBAK_2"."BSTNK" = "VBAK_1"."BSTNK"
 AND "VBAK_2"."MATNR" = "SILVER_VENTAS_SAP"."ID_SKU_ORIGEN" 

/* LIPS: obtener 1 entrega (la MAYOR) para el pedido Z007 + MATNR */
LEFT JOIN (
    SELECT
        l."VGBEL",
        l."VBELN",
        l."POSNR",
        l."MATNR"
    FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_LIPS" l
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY l."VGBEL", l."MATNR"
        ORDER BY l."VBELN" DESC
    ) = 1
) AS "LIPS_N"
  ON "LIPS_N"."VGBEL" = "VBAK_2"."VBELN_Z007"
 AND "LIPS_N"."MATNR" = "SILVER_VENTAS_SAP"."ID_SKU_ORIGEN" 

/* MSEG_N: ahora sí, amarrado a la ENTREGA de LIPS (VBELN) + POSNR + MATNR */
LEFT JOIN (
    SELECT
        m."VBELN_IM",
        m."VBELP_IM",
        m."MATNR",
        m."BWART",
        m."SAKTO",
        m."MBLNR"
    FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_MSEG" m
    WHERE m."MBLNR" IS NOT NULL
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY m."VBELN_IM", m."VBELP_IM", m."MATNR"
        ORDER BY m."MBLNR" DESC
    ) = 1
) AS MSEG_N
  ON MSEG_N."VBELN_IM" = "LIPS_N"."VBELN"
 AND MSEG_N."VBELP_IM" = "LIPS_N"."POSNR"
 AND MSEG_N."MATNR"     = "SILVER_VENTAS_SAP"."ID_SKU_ORIGEN" 

WHERE "SILVER_VENTAS_SAP"."FECHA_FACTURA" >= '2025-01-01'
  AND "SILVER_VENTAS_SAP"."ID_PAIS" = 'GT'
--   AND "SILVER_VENTAS_SAP"."ID_FACTURA" = '0951992229'
;

DROP VIEW IF EXISTS DEV_GOLD_M.COMERCIAL.GOLD_VENTAS_SAP_FINANCIERO_GT;
SELECT
ID_FACTURA, 
ID_FACTURA_REFERENCIA, 
CLASE_FACTURA, 
CLAVE_CUENTA, 
FECHA, 
UUID, 
SERIE, 
NUMERO, 
CLASE_MOV, 
CUENTA_COSTO
FROM TEST_GOLD.COMERCIAL.GOLD_VENTAS_SAP_FINANCIERO_GT 
WHERE ID_FACTURA IN ('0951993245', '951992229')
;
SELECT * FROM TEST_GOLD.COMERCIAL.GOLD_VENTAS_SAP_FINANCIERO_GT 
LIMIT 10; 

S1
ZD40
ZD42
-- NEGATIVOS
; 
/* VERSION FINAL OPTIMIZADA  */
WITH ventas_base AS (
  SELECT
    *
  FROM DEV_SILVER_M.COMERCIAL.SILVER_VENTAS_SAP
  WHERE FECHA_FACTURA >= DATE '2025-01-01'
    AND ID_PAIS = 'GT'
),
konv_pivot AS (
  -- 1 sola lectura de KONV para ZPRE/PB00
  SELECT
    KNUMV,
    KPOSN,
    MANDT,
    MAX(IFF(KSCHL = 'ZPRE', SAKN1, NULL)) AS SAKN1_ZPRE,
    MAX(IFF(KSCHL = 'ZPRE', KVSL1, NULL)) AS KVSL1_ZPRE,
    MAX(IFF(KSCHL = 'PB00', SAKN1, NULL)) AS SAKN1_PB00,
    MAX(IFF(KSCHL = 'PB00', KVSL1, NULL)) AS KVSL1_PB00
  FROM DEV_BRONZE_M.BRONZE_STAGING.STM_KONV
  WHERE KINAK = 'NA'
    AND KSCHL IN ('ZPRE', 'PB00')
  GROUP BY 1,2,3
),
mseg_latest AS (
  -- 1 sola deduplicación reutilizable para los 2 casos (M y N)
  SELECT
    VBELN_IM,
    VBELP_IM,
    MATNR,
    BWART,
    SAKTO,
    MBLNR
  FROM DEV_BRONZE_M.BRONZE_STAGING.STM_MSEG
  WHERE MBLNR IS NOT NULL
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY VBELN_IM, VBELP_IM, MATNR
    ORDER BY MBLNR DESC
  ) = 1
),
vbak_z007_latest AS (
  SELECT
    v.VKORG,
    v.BSTNK,
    p.MATNR,
    v.VBELN AS VBELN_Z007
  FROM DEV_BRONZE_M.BRONZE_STAGING.STM_VBAK v
  JOIN DEV_BRONZE_M.BRONZE_STAGING.STM_VBAP p
    ON p.VBELN = v.VBELN
  WHERE v.AUART = 'Z007'
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY v.VKORG, v.BSTNK, p.MATNR
    ORDER BY v.VBELN DESC
  ) = 1
),
lips_latest AS (
  SELECT
    VGBEL,
    VBELN,
    POSNR,
    MATNR
  FROM DEV_BRONZE_M.BRONZE_STAGING.STM_LIPS
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY VGBEL, MATNR
    ORDER BY VBELN DESC
  ) = 1
)
SELECT
-- COUNT(*)
--   v.MANDANTE,
--   v.ID_FACTURA,
--   v.ID_FACTURA_REFERENCIA,
--   v.CLASE_FACTURA,
--   v.TIPO_FACTURA,
--   v.TIPO_DOCUMENTO_COMERCIAL,
--   v.POSICION,
--   v.LOTE,
--   v.TIPO_POSICION,
--   v.NOM_TIPO_POSICION,
--   v.ID_PEDIDO,
--   v.ID_ENTREGA,
--   v.KUNAG,
--   v.ID_CLIENTE_ORIGEN,
--   v.ID_SOCIEDAD,
--   v.ID_PAIS,
--   v.ID_SOCIEDAD_ORIGEN,
--   v.ID_CENTRO_ORIGEN,
--   v.ID_ALMACEN_ORIGEN,
--   v.ID_CANAL,
--   v.ID_SUBCANAL,
--   v.ID_SKU_ORIGEN,
--   v.NOM_SKU,
--   v.ID_GRUPO_ARTICULOS,
--   v.ID_TIPO_MATERIAL,
--   v.CANTIDAD_FACTURADA,
--   v.UNIDAD_FACTURADA,
--   v.FC_NUMERADOR,
--   v.FC_DENOMINADOR,
--   v.UNIDAD_BASE,
--   v.CANTIDAD_UNIDAD_BASE,
--   v.VOLUMEN,
--   v.UNIDAD_VOLUMEN,
--   v.LITROS_FACTURA_CALCULADO,
--   v.LITROS_CALCULADOS_SNOW,
--   v.PQT_MATCAT,
--   v.PQT_CALCULADOS_SNOW,
--   v.PESO_NETO,
--   v.PESO_BRUTO,
--   v.UNIDAD_PESO,
--   v.MONEDA_DOCUMENTO,
--   v.MONTO_NETO_DOCUMENTO,
--   v.FC_MONEDA_LOCAL,
--   v.MONTO_NETO_MONEDA_LOCAL,
--   v.MONTO_BASE1,
--   v.MONTO_BASE1_MONEDA_LOCAL,
--   v.ID_CONDICION_DE_PAGO,
--   v.IMPUESTO_DETALLADO_MONEDA_DOCUMENTO,
--   v.IMPUESTO_DETALLADO_MONEDA_LOCAL,
--   v.COSTE_MONEDA_DOCUMENTO,
--   v.COSTE_MONEDA_LOCAL,
--   v.ID_GRUPO_PRECIOS_CLIENTE,
--   v.ID_GRUPO_CLIENTES,
--   v.TIPO_LISTA_PRECIO,
--   v.FLAG_FACTURA_ANULADA,
--   v.FECHA_FACTURA,
--   v.PERIODO,
--   v.PRSFD,
--   v.ESTADO_LIQUIDACION,
--   v.FECHA_LIQUIDACION,
--   v.NUMERO_DE_CONDICION,
  COALESCE(k.SAKN1_ZPRE, k.SAKN1_PB00, 'NA') AS NUMERO_CUENTA_MAYOR,
  COALESCE(k.KVSL1_ZPRE, k.KVSL1_PB00, 'NA') AS CLAVE_CUENTA,
  COALESCE(TO_VARCHAR(z.FECHA), 'NA') AS FECHA,
  COALESCE(z.UUID,   'NA') AS UUID,
  COALESCE(z.SERIE,  'NA') AS SERIE,
  COALESCE(z.NUMERO, 'NA') AS NUMERO,
  COALESCE(m_m.BWART, m_n.BWART, 'NA') AS CLASE_MOV,
  COALESCE(m_m.SAKTO, m_n.SAKTO, 'NA') AS CUENTA_COSTO
FROM ventas_base v
LEFT JOIN konv_pivot k
  ON k.KNUMV = v.NUMERO_DE_CONDICION
 AND k.KPOSN = v.POSICION
 AND k.MANDT = v.MANDANTE
LEFT JOIN DEV_BRONZE_M.BRONZE_STAGING.STM_ZFEL_RESULT z
  ON z.VBELN = v.ID_FACTURA
-- CASO M
LEFT JOIN mseg_latest m_m
  ON m_m.VBELN_IM = v.ID_ENTREGA
 AND m_m.VBELP_IM = v.VGPOS
 AND m_m.MATNR    = v.ID_SKU_ORIGEN
-- CASO N
LEFT JOIN DEV_BRONZE_M.BRONZE_STAGING.STM_VBAP vbap_1
  ON vbap_1.VBELN = v.ID_ENTREGA
 AND vbap_1.POSNR = v.VGPOS
 AND vbap_1.MATNR = v.ID_SKU_ORIGEN
LEFT JOIN DEV_BRONZE_M.BRONZE_STAGING.STM_VBAK vbak_1
  ON vbak_1.VBELN = vbap_1.VBELN
 AND vbak_1.VKORG = v.VKORG
LEFT JOIN vbak_z007_latest vbak_2
  ON vbak_2.VKORG = v.VKORG
 AND vbak_2.BSTNK = vbak_1.BSTNK
 AND vbak_2.MATNR = v.ID_SKU_ORIGEN
LEFT JOIN lips_latest l_n
  ON l_n.VGBEL = vbak_2.VBELN_Z007
 AND l_n.MATNR = v.ID_SKU_ORIGEN
LEFT JOIN mseg_latest m_n
  ON m_n.VBELN_IM = l_n.VBELN
 AND m_n.VBELP_IM = l_n.POSNR
 AND m_n.MATNR    = v.ID_SKU_ORIGEN --3 692 704
where v."ID_FACTURA" = '0951993245'
;



