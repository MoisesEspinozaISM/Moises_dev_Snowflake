select * from STAGING_PE_CH.SQL_FABRIC.STOCK limit 1000; 

SELECT DISTINCT IDFECHA FROM STAGING_PE_CH.SQL_FABRIC.STOCK ORDER BY IDFECHA DESC;
-- DESDE EL 2020 SE TIENE UN HISTORICO 

SELECT COUNT(*),
IDFECHA
FROM STAGING_PE_CH.SQL_FABRIC.STOCK
GROUP BY IDFECHA 
ORDER BY IDFECHA ASC;

SELECT 
    COLUMN_NAME,
    DATA_TYPE
FROM STAGING_PE_CH.INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'SQL_FABRIC'
  AND TABLE_NAME = 'STOCK'
ORDER BY ORDINAL_POSITION;

SELECT * FROM STAGING_PE_CH.SQL_FABRIC.STOCK
WHERE CANTIDAD_LIBREUTL <> 0
AND IDFECHA = '20251012';

SELECT DISTINCT IDDPT FROM STAGING_PE_CH.SQL_FABRIC.STOCK ORDER BY IDDPT;

// QUERT STOCK ALMACEN - PE-CH 

SELECT
CONCAT(CO.PAIS,'-',CO.SOCIEDAD) as ID_SOCIEDAD, 
CO.SOCIEDAD AS ID_SOCIEDAD_ORIGEN,
CO.PAIS AS ID_PAIS, 
ST.IDDPT AS ID_CENTRO_OPERATIVO_ORIGEN, 
ST.IDALMACEN AS ID_CENTRO_ALMACEN_ORIGEN, 
ST.IDPRODUCTO AS ID_SKU_ORIGEN,
ST.CANTIDAD_LIBREUTL AS STOCK_PISO,
ST.ENCTROLCALIDAD AS STOCK_INSPECCION, 
ST.bloqueado AS STOCK_BLOQUEADO,
ST.DSUNIDMED AS uNIDAD_MEDIDA, 
TO_DATE(TO_VARCHAR(ST.idfecha), 'YYYYMMDD') AS FECHA_CORTE
FROM STAGING_PE_CH.SQL_FABRIC.STOCK ST
INNER JOIN STAGING_PE_CH.SQL_FABRIC.CO CO 
ON ST.IDDPT = CO.IDDPT
;

-- Antes de Join : 36239569
-- Desues de Join :36239569

SELECT * FROM STAGING_PE_CH.SQL_FABRIC.CO ; 

            SELECT "PK", COUNT(*)
            FROM "DEV_BRONZE_M"."SUPPLY"."STOCK_ALMACEN_PE_CH" 
            GROUP BY "PK"
            HAVING COUNT(*) > 1
            ;

SELECT * FROM DEV_BRONZE_M.SUPPLY.STOCK_ALMACEN_PE_CH
WHERE PK = '2000-PE-28-2000-2015-20250518-1-000000000000002111'
;

SELECT * FROM STAGING_PE_CH.SQL_FABRIC.STOCK 
WHERE IDPRODUCTO = '1-000000000000002111'
AND IDALMACEN = '2000-2015'
AND IDDPT = '28'
AND IDFECHA = '20250518'
ORDER BY TO_TIME(HORA) DESC
LIMIT 1;
;

  SELECT *
  FROM "DEV_BRONZE_M"."SUPPLY"."STG_STOCK"
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY "IDDPT", "IDALMACEN", "IDFECHA", "IDPRODUCTO"
    ORDER BY 
      TO_TIME(NVL("HORA",'00:00:00')) DESC,   -- hora m√°s reciente
      "FEADD" DESC                            -- desempate por fecha de carga
  ) = 1
  