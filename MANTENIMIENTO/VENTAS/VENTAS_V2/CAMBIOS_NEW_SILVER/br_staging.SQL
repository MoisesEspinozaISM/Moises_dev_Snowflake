WITH VENTAS_br_totoal as (
SELECT CONCAT(
    "VIEW_VENDASBR_ML"."ID_NF",
    '-',
    "VIEW_VENDASBR_ML"."CONSUMERS_ID",
    '-',
    "VIEW_VENDASBR_ML"."ROUTEID",
    '-',
    TO_DATE("VIEW_VENDASBR_ML"."SALESDATE"),
    '-',
    "VIEW_VENDASBR_ML"."SALESCHANNEL",
    '-',
    "VIEW_VENDASBR_ML"."SKUCODE"
  ) AS "ID_VENTA",
  'NA' AS "ID_PEDIDO",
  TO_VARCHAR("VIEW_VENDASBR_ML"."ID_NF") AS "ID_ENTREGA",
  TO_VARCHAR("VIEW_VENDASBR_ML"."CONSUMERS_ID") AS "ID_CLIENTE_ORIGEN",
  TO_VARCHAR("VIEW_VENDASBR_ML"."SALESCHANNEL") AS "ID_CANAL",
  TO_VARCHAR("VIEW_VENDASBR_ML"."COD_RAMO") AS "ID_SUBCANAL",
  CONCAT(
    'BR',
    '-',
    CAST("VIEW_VENDASBR_ML"."SOCIEDAD" AS STRING)
  ) AS "ID_SOCIEDAD",
  'BR' AS "ID_PAIS",
  CAST("VIEW_VENDASBR_ML"."SOCIEDAD" AS STRING) AS "ID_SOCIEDAD_ORIGEN",
  CAST("VIEW_VENDASBR_ML"."SOCIEDAD" AS STRING) AS "ID_CENTRO_ORIGEN",
  TO_VARCHAR("VIEW_VENDASBR_ML"."SKUCODE") AS "ID_SKU_ORIGEN",
  COALESCE(
    "VIEW_PRODUTOS_ML"."MEMBERNAME",
    "VIEW_PROD_ISM"."PROD_DESC",
    'NA'
  ) AS "NOM_SKU",
  TO_VARCHAR("VIEW_VENDASBR_ML"."ROUTEID") AS "ID_VENDEDOR",
  'NA' AS "ID_DISTRIBUIDOR",
  TO_VARCHAR("VIEW_VENDASBR_ML"."ROUTEID") AS "ID_RUTA",
  TO_VARCHAR("VIEW_VENDASBR_ML"."ID_NF") AS "ID_FACTURA_VENTA",
  'NA' AS "ID_FACTURA_RECHAZO",
  SUM(
    COALESCE("VIEW_VENDASBR_ML"."QTY_VENDA", 0) * COALESCE("VIEW_PRODUTOS_ML"."FACTOR_CX", 0)
  ) AS "CANTIDAD_VENDIDA_UN",
  0 AS "CANTIDAD_RECHAZO_UN",
  SUM(
    COALESCE("VIEW_VENDASBR_ML"."QTY_BONIF", 0) * COALESCE("VIEW_PRODUTOS_ML"."FACTOR_CX", 0)
  ) AS "CANTIDAD_BONIFICADA_UN",
  SUM("VIEW_VENDASBR_ML"."VLR_VENTA") AS "MONTO_VENTA",
  0 AS "MONTO_RECHAZO",
  SUM("VIEW_VENDASBR_ML"."VLR_VENTA") AS "MONTO_VENTA_NETA",
  SUM(
    "VIEW_VENDASBR_ML"."ICMS" + "VIEW_VENDASBR_ML".IPI + "VIEW_VENDASBR_ML"."SUBSTITUTO" + "VIEW_VENDASBR_ML"."COFINS" + "VIEW_VENDASBR_ML"."PIS"
  ) AS "IMPUESTO_TOTAL_VENTA",
  SUM(
    COALESCE("VIEW_VENDASBR_ML"."QTY_VENDA", 0) * COALESCE("VIEW_PRODUTOS_ML"."FACTOR_CX", 0)
  ) AS "VENTA_NETA_UN",
  0 AS "IMPUESTO_TOTAL_RECHAZO",
  SUM(
    "VIEW_VENDASBR_ML"."ICMS" + "VIEW_VENDASBR_ML".IPI + "VIEW_VENDASBR_ML"."SUBSTITUTO" + "VIEW_VENDASBR_ML"."COFINS" + "VIEW_VENDASBR_ML"."PIS"
  ) AS "IMPUESTO_TOTAL_NETA",
  SUM(
    COALESCE("VIEW_VENDASBR_ML"."QTY_VENDA", 0) * COALESCE("VIEW_PRODUTOS_ML"."LITRAGEM", 0)
  ) AS "LITROS_VENDIDOS",
  SUM(
    COALESCE("VIEW_VENDASBR_ML"."QTY_VENDA", 0) * COALESCE("VIEW_PRODUTOS_ML"."LITRAGEM", 0)
  ) AS "LITROS_VENDIDOS_NETOS",
  SUM(
    (
      COALESCE("VIEW_VENDASBR_ML"."QTY_BONIF", 0) * COALESCE("VIEW_PRODUTOS_ML"."LITRAGEM", 0)
    )
  ) AS "LITROS_BONIFICADOS",
  SUM("VIEW_VENDASBR_ML"."QTY_VENDA") AS "PQT_VENDIDOS",
  SUM("VIEW_VENDASBR_ML"."QTY_VENDA") AS "PQT_NETOS",
  SUM("VIEW_VENDASBR_ML"."QTY_BONIF") AS "PQT_BONIFICADOS",
  TO_DATE("VIEW_VENDASBR_ML"."SALESDATE") AS "FECHA",
  TO_CHAR("VIEW_VENDASBR_ML"."SALESDATE", 'YYYYMM') AS "PERIODO",
  "VIEW_VENDASBR_ML"."D_NEGOCIO" AS "D_NEGOCIO",
  TO_DATE("VIEW_VENDASBR_ML"."DATA_LIB") AS "FECHA_LIQUIDACION",
  SUM("VIEW_VENDASBR_ML"."VLR_DESC") AS "MONTO_DESCUENTO",
  "VIEW_VENDASBR_ML"."SVR" AS "SVR",
  SUM("VIEW_VENDASBR_ML"."ICMS") AS "ICMS",
  SUM("VIEW_VENDASBR_ML"."IPI") AS "IPI",
  SUM("VIEW_VENDASBR_ML"."SUBSTITUTO") AS "SUBSTITUTO",
  SUM("VIEW_VENDASBR_ML"."COFINS") AS "COFINS",
  SUM("VIEW_VENDASBR_ML"."PIS") AS "PIS", 
  "VIEW_VENDASBR_ML".MOVEMENTYPE AS MOVEMENTYPE,
  "VIEW_VENDASBR_ML".D_SITUACAO as D_SITUACAO
FROM STAGING_BR.ORACLE."VIEW_VENDASBR_ML" VIEW_VENDASBR_ML
  LEFT JOIN STAGING_BR.ORACLE."VIEW_PRODUTOS_ML" "VIEW_PRODUTOS_ML" ON VIEW_PRODUTOS_ML."SOCIEDAD" = VIEW_VENDASBR_ML."SOCIEDAD"
  AND "VIEW_PRODUTOS_ML"."SKU" = "VIEW_VENDASBR_ML"."SKUCODE"
  LEFT JOIN STAGING_BR.ORACLE."VIEW_PROD_ISM" "VIEW_PROD_ISM" ON "VIEW_PRODUTOS_ML"."SKU" = "VIEW_PROD_ISM"."PROD_ID"
GROUP BY "VIEW_VENDASBR_ML"."ID_NF",
  "VIEW_VENDASBR_ML"."SKUCODE",
  "VIEW_VENDASBR_ML"."CONSUMERS_ID",
  "VIEW_VENDASBR_ML"."SALESCHANNEL",
  "VIEW_VENDASBR_ML"."SOCIEDAD",
  "VIEW_VENDASBR_ML"."COD_RAMO",
  "VIEW_VENDASBR_ML"."ROUTEID",
  "VIEW_VENDASBR_ML"."SALESDATE",
  "VIEW_VENDASBR_ML"."D_NEGOCIO",
  "VIEW_PRODUTOS_ML"."UNIDAD_NEGOCIO",
  "VIEW_PROD_ISM"."PROD_DESC",
  "VIEW_PRODUTOS_ML"."MEMBERNAME",
  CONCAT('BR-', CAST("VIEW_VENDASBR_ML"."SOCIEDAD" AS STRING)),
  "VIEW_VENDASBR_ML"."DATA_LIB",
  "VIEW_VENDASBR_ML"."SVR", 
  "VIEW_VENDASBR_ML".D_SITUACAO, 
  "VIEW_VENDASBR_ML".MOVEMENTYPE
)
SELECT
  SUM(litros_vendidos) AS litros_vendidos,
  SUM(litros_bonificados) AS litros_bonificados,
  SUM(pqt_vendidos)    AS pqt_vendidos,
  SUM(pqt_bonificados) AS pqt_bonificados,
  SUM(monto_venta)     AS monto_venta,
  SUM(monto_descuento) AS monto_descuento,
  d_situacao,
  d_negocio,
  svr,
  MOVEMENTYPE,
  periodo
FROM VENTAS_br_totoal
WHERE periodo >= '202401'
GROUP BY d_situacao, d_negocio, svr, periodo, MOVEMENTYPE
ORDER BY periodo, svr, d_situacao, d_negocio, MOVEMENTYPE ASC;