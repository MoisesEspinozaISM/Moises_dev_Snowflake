select * from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO' 
limit 10; 

select DISTINCT CLASE_FACTURA from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO' 
; 

select
PERIODO, 
CLASE_FACTURA, 
TIPO_POSICION,
nom_tipo_posicion,
id_canal,
ID_SKU_ORIGEN,
NOM_SKU, 
SUM(LITROS_FACTURA_CALCULADO), 
SUM(pqt_matcat) ,
SUM(MONTO_NETO_MONEDA_LOCAL), 
CASE 
    WHEN MONTO_NETO_MONEDA_LOCAL <> 0 THEN 'NORMALES'
    ELSE 'GRATUITAS'
END AS FLAG_MONTO
from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO'
AND ID_SOCIEDAD_ORIGEN = '1000'
AND ID_CENTRO_ORIGEN = '1001'
AND PERIODO = '202508'
and id_tipo_material = 'ZFER'
--AND MONTO_NETO_MONEDA_LOCAL <> 0
GROUP BY PERIODO, 
CLASE_FACTURA, 
TIPO_POSICION,
nom_tipo_posicion,
id_canal,
ID_SKU_ORIGEN,
NOM_SKU,
FLAG_MONTO
;

select 
ID_FACTURA, 
ID_FACTURA_REFERENCIA, 
ID_CLIENTE_ORIGEN,
CLASE_FACTURA, 
TIPO_DOCUMENTO_COMERCIAL, 
TIPO_POSICION, 
NOM_TIPO_POSICION,
FLAG_FACTURA_ANULADA, 
ID_SKU_ORIGEN, 
NOM_SKU,
PQT_MATCAT
from dev_silver_m.comercial.silver_ventas_sap
where id_factura_referencia = '2100223991'
and CLASE_FACTURA IN  ('ZC01', 'ZD01', 'ZF01','ZP01')
AND MONTO_NETO_MONEDA_LOCAL <> 0
AND FLAG_FACTURA_ANULADA <> 'X'
ORDER BY FLAG_FACTURA_ANULADA ASC; 

select
ID_FACTURA_REFERENCIA,
PERIODO, 
CLASE_FACTURA, 
TIPO_POSICION,
nom_tipo_posicion,
id_canal,
ID_SKU_ORIGEN,
NOM_SKU, 
SUM(LITROS_FACTURA_CALCULADO), 
SUM(pqt_matcat),
SUM(MONTO_NETO_MONEDA_LOCAL), 
-- CASE 
--     WHEN MONTO_NETO_MONEDA_LOCAL <> 0 THEN 'NORMALES'
--     ELSE 'GRATUITAS'
-- END AS FLAG_MONTO
from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO'
AND ID_SOCIEDAD_ORIGEN = '1000'
AND ID_CENTRO_ORIGEN = '1001'
AND PERIODO = '202508'
and id_tipo_material = 'ZFER'
AND CLASE_FACTURA IN ('ZC01', 'ZD01', 'ZF01','ZP01') -- ZG01 
AND FLAG_FACTURA_ANULADA <> 'X'
AND MONTO_NETO_MONEDA_LOCAL <> 0
GROUP BY PERIODO, 
CLASE_FACTURA, 
TIPO_POSICION,
nom_tipo_posicion,
id_canal,
ID_SKU_ORIGEN,
NOM_SKU,
ID_FACTURA_REFERENCIA,
FLAG_MONTO
;

/////////////////////// 


select
PERIODO, 
id_canal,
SUM(
    CASE 
        WHEN CLASE_FACTURA = 'ZD01' THEN -LITROS_FACTURA_CALCULADO
        ELSE LITROS_FACTURA_CALCULADO
    END
) AS LITROS, 
SUM(
    CASE WHEN CLASE_FACTURA = 'ZD01' THEN -pqt_matcat
    ELSE pqt_matcat
    END
) AS PQT,
SUM(
    CASE WHEN CLASE_FACTURA = 'ZD01' THEN -MONTO_NETO_MONEDA_LOCAL
    ELSE MONTO_NETO_MONEDA_LOCAL
    END
) AS MONTO 
from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO'
AND ID_SOCIEDAD_ORIGEN = '1000'
AND ID_CENTRO_ORIGEN = '1001'
AND PERIODO = '202508'
and id_tipo_material = 'ZFER'
AND CLASE_FACTURA IN ('ZC01', 'ZD01', 'ZF01','ZP01')
AND FLAG_FACTURA_ANULADA <> 'X'
AND MONTO_NETO_MONEDA_LOCAL <> 0
-- AND ESTADO_LIQUIDACION NOT IN ('RT')
and id_factura_referencia not in
(select distinct id_factura_referencia from dev_silver_m.comercial.silver_ventas_sap where estado_liquidacion ='RT')
GROUP BY PERIODO, id_canal
order by  PERIODO, id_canal desc
;

SELECT DISTINCT ESTADO_LIQUIDACION FROM dev_silver_m.comercial.silver_ventas_sap 
WHERE ID_PAIS = 'DO'
AND ESTADO_LIQUIDACION <> 'NA'; 

select
PERIODO, 
id_canal,
SUM(LITROS_FACTURA_CALCULADO) AS LITROS, 
SUM(pqt_matcat) AS PQT,
SUM(MONTO_NETO_MONEDA_LOCAL) AS MONTO, 
SUM(LITROS_FACTURA_CALCULADO*-1) AS LITROS_M, 
SUM(pqt_matcat*-1) AS PQT_m,
SUM(MONTO_NETO_MONEDA_LOCAL*-1) AS MONTO_m, 
from dev_silver_m.comercial.silver_ventas_sap
WHERE ID_PAIS = 'DO'
AND ID_SOCIEDAD_ORIGEN = '1000'
AND ID_CENTRO_ORIGEN = '1001'
AND PERIODO = '202508'
and id_tipo_material = 'ZFER'
AND CLASE_FACTURA IN ('ZC01', 'ZF01','ZP01')
AND FLAG_FACTURA_ANULADA <> 'X'
AND MONTO_NETO_MONEDA_LOCAL <> 0
AND ESTADO_LIQUIDACION IN ('RT') 
GROUP BY PERIODO, 
id_canal
; 

SELECT * FROM dev_silver_m.comercial.silver_ventas_sap
where id_factura_referencia = '2100223991'
; 

-------------------- 


SELECT
COUNT(*)
-- STM_VBRK.VBELN AS ID_FACTURA,
-- STM_VBRK.FKDAT AS FECHA_FACTURA,
-- STM_VBRK.LAND1 AS PAIS,
-- STM_VBRK.BUKRS AS SOCIEDAD,
-- STM_VBRK.KUNAG AS ID_CLIENTE_ORIGEN,
-- STM_VBRP.POSNR AS POSICION_FACTURA,
-- STM_VBRP.MATNR AS ID_SKU_ORIGEN,
-- COALESCE(STM_ZFIT_HEAD_LIQR_FV.STATUS, STM_ZFIT_HEAD_LIQR_FVR.STATUS) AS STATUS,
-- COALESCE(STM_ZFIT_HEAD_LIQR_FV.F_LIQ, STM_ZFIT_HEAD_LIQR_FVR.F_LIQ) AS F_LIQ
FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRK" "STM_VBRK"
  INNER JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRP" "STM_VBRP" ON "STM_VBRK"."VBELN" = "STM_VBRP"."VBELN"
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STG_MARA" STG_MARA ON "STG_MARA"."MATNR" = "STM_VBRP"."MATNR"
  -- 218 843 533 -- antes del join
  -- 218 843 533 -- PRIMER JOIN 
  -- 218 843 533
  LEFT JOIN (
    SELECT MANDT, VBELN_VF, STATUS, F_LIQ , AUGRU,
        ROW_NUMBER() OVER (
            PARTITION BY VBELN_VF 
            ORDER BY 
                CASE WHEN NETWR_F <> 0 THEN 0 ELSE 1 END,
                NETWR_F DESC,
                VBELN DESC
        ) AS RN
    FROM DEV_BRONZE_M.BRONZE_STAGING.STM_ZFIT_HEAD_LIQR
  ) AS STM_ZFIT_HEAD_LIQR_FV
    ON STM_ZFIT_HEAD_LIQR_FV.VBELN_VF = STM_VBRK.VBELN     
    AND STM_ZFIT_HEAD_LIQR_FV.RN = 1
  LEFT JOIN (
    SELECT  VBELN_VFR, STATUS, F_LIQ , AUGRU,
        ROW_NUMBER() OVER (
            PARTITION BY VBELN_VFR 
            ORDER BY 
                CASE WHEN NETWR_F <> 0 THEN 0 ELSE 1 END,
                NETWR_F DESC,
                VBELN DESC
        ) AS RN
    FROM DEV_BRONZE_M.BRONZE_STAGING.STM_ZFIT_HEAD_LIQR
  ) AS STM_ZFIT_HEAD_LIQR_FVR
    ON STM_ZFIT_HEAD_LIQR_FVR.VBELN_VFR = STM_VBRK.VBELN     
    AND STM_ZFIT_HEAD_LIQR_FVR.RN = 1
WHERE "STM_VBRK"."FKDAT" <= CURRENT_DATE()
AND  "STM_VBRK".XBLNR  = '2100223991'
; 


SELECT VBELN_VF, COUNT(*) AS veces
FROM "DEV_BRONZE_M"."BRONZE_STAGING".STM_ZFIT_HEAD_LIQR
WHERE VBELN_VF IS NOT NULL
GROUP BY VBELN_VF
HAVING COUNT(*) > 1
ORDER BY veces DESC

; 

SELECT VBELN_VFR, COUNT(*) AS veces
FROM "DEV_BRONZE_M"."BRONZE_STAGING".STM_ZFIT_HEAD_LIQR
WHERE VBELN_VFR IS NOT NULL
GROUP BY VBELN_VFR
HAVING COUNT(*) > 1
ORDER BY veces DESC
;
WITH FACTURAS_VENTA AS (
    SELECT DISTINCT
        VBELN_VFR, 
        STATUS, 
        F_LIQ , 
        AUGRU, 
        NETWR_F,
        VBELN,
        ROW_NUMBER() OVER (
            PARTITION BY VBELN_VFR 
            ORDER BY 
                CASE WHEN NETWR_F <> 0 THEN 0 ELSE 1 END,
                NETWR_F DESC,
                VBELN DESC
        ) AS RN
    FROM DEV_BRONZE_M.BRONZE_STAGING.STM_ZFIT_HEAD_LIQR
    WHERE VBELN_VFR = '1057927743'
) 
SELECT VBELN_VFR, COUNT(*) AS veces
FROM FACTURAS_VENTA
WHERE VBELN_VFR IS NOT NULL
AND RN = 1
GROUP BY VBELN_VFR
HAVING COUNT(*) > 1
;

SELECT *
FROM "DEV_BRONZE_M"."BRONZE_STAGING".STM_ZFIT_HEAD_LIQR
where VBELN_VF = '0950331377'; 

SELECT *
FROM "DEV_BRONZE_M"."BRONZE_STAGING".STM_ZFIT_HEAD_LIQR
where VBELN_VFR = '1057927743'; 

SELECT * FROM DEV_BRONZE_M.BRONZE_STAGING.STM_VBRK
INNER JOIN DEV_BRONZE_M.BRONZE_STAGING.STM_VBRP
ON STM_VBRK.VBELN = STM_VBRP.VBELN
WHERE XBLNR = '7115107399'

; 
SELECT * FROM DEV_BRONZE_M.BRONZE_STAGING.STM_ZFIT_HEAD_LIQR
WHERE VBELN_VF = '0950334694'
AND NETWR_F <> 0
;
    SELECT DISTINCT 
     VBELN_VF, VBELN_VFR, VBELN, STATUS, F_LIQ , DATEN, AUGRU, NETWR_F, NETWR_FR
    FROM DEV_BRONZE_M.BRONZE_STAGING.STM_ZFIT_HEAD_LIQR
    WHERE VBELN_VF = '0950334694'
; 

SELECT AUBEL, VGBEL , VBELN , MATNR, VRKME, FKIMG, VOLUM, NETWR, PSTYV FROM DEV_BRONZE_M.BRONZE_STAGING.STM_VBRP
WHERE VGBEL = '0850348624';

; 
