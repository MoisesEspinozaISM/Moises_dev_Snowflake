SELECT * FROM STAGING_RD_HT_GT.SAP.VBRK
LIMIT 10; 

SELECT
vbeln, 
fkart, 
fktyp, 
vbtyp, 
waerk, 
vkorg,
vtweg, 
fkdat, 
pltyp, 
zterm, 
land1,
landtx,  
regio, 
bukrs, 
netwr, 
erdat ,
kunrg, 
kunag, 
stwae, 
spart, 
kkber, 
knkli, 
cmwae, 
xblnr, 
MWSBK
FROM STAGING_RD_HT_GT.SAP.VBRK
LIMIT 10; 

SELECT * FROM STAGING_RD_HT_GT.SAP.VBRP
LIMIT 10; 

CREATE SCHEMA DEV_BRONZE_M.BRONZE_STAGING; 
SELECT 
    MATNR      AS sku,
    FKIMG      AS cantidad_facturada_venta,
    VRKME      AS unidad_venta,
    UMVKZ      AS factor_conversion_numerador,
    UMVKN      AS factor_conversion_denominador,
    MEINS      AS unidad_base,
    FKLMG      AS cantidad_en_unidad_base,
    VOLUM      AS volumen_total,
    VOLEH      AS unidad_volumen
FROM STAGING_RD_HT_GT.SAP.VBRP
WHERE UMVKN <> 1
LIMIT 1000;

SELECT * FROM STAGING_RD_HT_GT.SAP.VBRK
WHERE VBELN = '0910157298';

SELECT 
VBELN,
POSNR, 
FKING
VRKME, 
UMVKZ,
MEINS, 
FKLMG, 
LIMENG, 
NTGEW, 
BRGEW, 
GEWEI, 
VOLUM,
VOLEH, 
NETWR, 
VGBEL, 
VGPOS, 
VGTYP, 
AUBEL, 
AUPOS, 
MATNR, 
ARKTX, 
CHARG, 
MATKL, 
pstyv, 
prodh, 
vstel, 
spart, 
pospa, 
werks, 
aland, 
wkreg, 
erdat, 
erzet, 
lgort, 
WAVWR, 
KZWI1, 
MATWA, 
BONBA,
KOKRS, 
PAOBJNR, 
CMPRE, 
XCHAR, 
AUTYP
FROM STAGING_RD_HT_GT.SAP.VBRP
; 

SELECT 
    VBRK.VBELN             AS factura_numero,
    VBRK.FKART             AS clase_documento_factura,
    VBRK.FKTYP             AS categoria_factura,
    VBRK.VBTYP             AS tipo_documento_ventas,
    VBRK.WAERK             AS moneda_documento,
    VBRK.VKORG             AS organizacion_ventas,
    VBRK.VTWEG             AS canal_distribucion,
    VBRK.FKDAT             AS fecha_factura,
    VBRK.PLTYP             AS tipo_lista_precios,
    VBRK.ZTERM             AS condiciones_pago,
    VBRK.LAND1             AS pais_cliente,
    VBRK.LANDTX            AS descripcion_pais,
    VBRK.REGIO             AS region,
    VBRK.BUKRS             AS sociedad,
    VBRK.NETWR             AS valor_neto_cabecera,
    VBRK.ERDAT             AS fecha_creacion_factura,
    VBRK.KUNRG             AS cliente_facturacion,
    VBRK.KUNAG             AS cliente_final,
    VBRK.STWAE             AS moneda_estadistica,
    VBRK.SPART             AS division,
    VBRK.KKBER             AS area_credito,
    VBRK.KNKLI             AS referencia_cliente,
    VBRK.CMWAE             AS moneda_compensacion,
    VBRK.XBLNR             AS referencia_externa,
    VBRK.MWSBK             AS importe_impuesto,
    
    VBRP.POSNR             AS posicion_factura,
    --VBRP.FKING             AS indicador_facturacion,
    VBRP.VRKME             AS unidad_venta,
    VBRP.UMVKZ             AS factor_conversion,
    VBRP.MEINS             AS unidad_medida_base,
    VBRP.FKLMG             AS cantidad_facturada,
    --VBRP.LIMENG            AS cantidad_limite,
    VBRP.NTGEW             AS peso_neto,
    VBRP.BRGEW             AS peso_bruto,
    VBRP.GEWEI             AS unidad_peso,
    VBRP.VOLUM             AS volumen,
    VBRP.VOLEH             AS unidad_volumen,
    VBRP.NETWR             AS valor_neto_posicion,
    VBRP.MATNR             AS material,
    VBRP.ARKTX             AS descripcion_material,
    VBRP.CHARG             AS lote,
    VBRP.MATKL             AS grupo_articulos,
    VBRP.PSTYV             AS tipo_posicion,
    VBRP.PRODH             AS jerarquia_productos,
    VBRP.VSTEL             AS punto_expedicion,
    VBRP.SPART             AS division_posicion,
    VBRP.WERKS             AS centro,
    VBRP.LGORT             AS almacen,
    VBRP.WAVWR             AS valor_bonificacion,
    VBRP.KZWI1             AS valor_condicion1,
    VBRP.MATWA             AS material_factura,
    VBRP.BONBA             AS grupo_bonus,
    VBRP.KOKRS             AS sociedad_co,
    VBRP.PAOBJNR           AS objeto_controlling,
    VBRP.CMPRE             AS precio_coste,
    VBRP.XCHAR             AS gestion_caracteristicas,
    VBRP.AUTYP             AS tipo_documento_origen
FROM STAGING_RD_HT_GT.SAP.VBRK VBRK
INNER JOIN STAGING_RD_HT_GT.SAP.VBRP VBRP
    ON VBRK.VBELN = VBRP.VBELN
LIMIT 100;

SELECT 
VBRK.VBELN AS ID_FACTURA,
VBRK.XBLNR AS ID_FACTURA_REFERENCIA,
VBRK.FKART AS CLASE_FACTURA, 
VBRK.FKTYP AS TIPO_FACTURA,
VBRK.VBTYP AS TIPO_DOCUMENTO_VENTAS, 
VBRP.POSNR AS POSICION, 
VBRP.CHARG AS LOTE,

VBRP.PSTYV AS TIPO_POSICION, 
VBRP.AUBEL AS ID_PEDIDO, 
VBRP.VGBEL AS ID_ENTREGA, 
VBRK.KUNAG AS ID_DISTRIBUIDOR, 

VBRK.KUNRG AS ID_CLIENTE_FACTURADO, 
VBRK.KUNAG AS ID_CLIENTE_FINAL,
VBRK.VTWEG AS ID_CANAL, 
VBRP.SPART AS ID_SUBCANAL, 
VBRK.LAND1 AS ID_PAIS, 
CONCAT(VBRK.LAND1,'-',VBRK.BUKRS) AS ID_SOCIEDAD,
VBRK.BUKRS AS ID_SOCIEDAD_ORIGEN, 
VBRK.VKORG AS ID_CENTRO_ORIGEN, 
VBRP.LGORT AS ID_ALMACEN_ORGIEN,
VBRP.MATNR AS ID_SKU_ORIGEN, 
VBRP.ARKTX AS NOM_SKU, 
VBRP.MATKL AS ID_GRUPO_ARTICULOS,

VBRP.FKIMG AS CANTIDAD_FACTURADA,
VBRP.VRKME AS UNIDAD_FACTURADA,
VBRP.UMVKZ AS FC_NUMERADOR,
VBRP.UMVKN AS FC_DENOMINADOR,
VBRP.MEINS AS UNIDAD_BASE,
VBRP.FKLMG AS CANTIDAD_UNIDAD_BASE,
VBRP.VOLUM AS VOLUMEN,
VBRP.VOLEH AS UNIDAD_VOLUMEN,
VBRP.NTGEW AS PESO_NETO,
VBRP.BRGEW AS PESO_BRUTO,
VBRP.GEWEI AS UNIDAD_PESO,

VBRK.WAERK AS MONEDA_DOCUMENTO, 
VBRP.NETWR AS MONTO_NETO_DOCUMENTO,
VBRK.KURRF AS FC_MONEDA_LOCAL, 
(VBRP.NETWR * VBRK.KURRF) AS MONTO_NETO_MONEDA_LOCAL,
VBRK.ZTERM AS CONDICION_PAGO,  
VBRP.KZWI1 AS MONTO_BASE, 
(VBRP.KZWI1 * VBRK.KURRF) AS  MONTO_BASE_MONEDA_LOCAL,
VBRP.MWSBP AS IMPUESTO_DETALLADO,
VBRP.CMPRE AS PRECIO_COSTE,
VBRK.PLTYP AS TIPO_LISTO_PRECIO, 
VBRK.FKDAT AS FECHA_FACTURA, 
TO_CHAR(TO_DATE(VBRK.FKDAT, 'YYYY-MM-DD'), 'YYYYMM') AS PERIODO,
VBRK.FKSTO AS FKSTO
FROM STAGING_RD_HT_GT.SAP.VBRK VBRK
INNER JOIN STAGING_RD_HT_GT.SAP.VBRP VBRP
    ON VBRK.VBELN = VBRP.VBELN
LIMIT 100; 


SELECT COUNT(*) FROM DEV_SILVER_M.COMERCIAL.SILVER_VENTAS_SAP; 
217 933 019
217 933 019

; 

SELECT * FROM DEV_BRONZE_M.BRONZE_STAGING.STG_TVAPT;  

SELECT COUNT(*) FROM DEV_BRONZE_M.BRONZE_STAGING.STG_TVAPT;  
-- 434 
SELECT DISTINCT PSTYV FROM DEV_BRONZE_M.BRONZE_STAGING.STG_TVAPT;  

SELECT DISTINCT LOTE, TIPO_POSICION FROM DEV_SILVER_M.COMERCIAL.SILVER_VENTAS_SAP
WHERE LOTE = 'VENTAS'
AND ID_PAIS = 'DO'
ORDER BY TIPO_POSICION ASC; 
SELECT DISTINCT LOTE FROM DEV_SILVER_M.COMERCIAL.SILVER_VENTAS_SAP
ORDER BY LOTE DESC;

/////////////////////////// QUERY EN SNOWFLAKE /////////////////////////// 

SELECT "STM_VBRK"."MANDT" AS "MANDANTE",
  "STM_VBRK"."VBELN" AS "ID_FACTURA",
  "STM_VBRK"."XBLNR" AS "ID_FACTURA_REFERENCIA",
  "STM_VBRK"."FKART" AS "CLASE_FACTURA",
  "STM_VBRK"."FKTYP" AS "TIPO_FACTURA",
  "STM_VBRK"."VBTYP" AS "TIPO_DOCUMENTO_COMERCIAL",
  "STM_VBRP"."POSNR" AS "POSICION",
  "STM_VBRP"."CHARG" AS "LOTE",
  "STM_VBRP"."PSTYV" AS "TIPO_POSICION",
  "STG_TVAPT"."VTEXT" AS "NOM_TIPO_POSICION",
  "STM_VBRP"."AUBEL" AS "AUBEL",
  "STM_VBRP"."VGBEL" AS "VGBEL",
  "STM_VBRK"."KUNAG" AS "KUNAG",
  "STM_VBRK"."KUNRG" AS "ID_CLIENTE_ORIGEN",
  CONCAT("STM_VBRK"."LAND1", '-', "STM_VBRK"."BUKRS") AS "ID_SOCIEDAD",
  "STM_VBRK"."LAND1" AS "ID_PAIS",
  "STM_VBRK"."BUKRS" AS "ID_SOCIEDAD_ORIGEN",
  "STM_VBRP"."WERKS" AS "ID_CENTRO_ORIGEN",
  "STM_VBRP"."LGORT" AS "ID_ALMACEN_ORIGEN",
  "STM_VBRK"."VTWEG" AS "ID_CANAL",
  "STM_VBRP"."SPART" AS "ID_SUBCANAL",
  "STM_VBRP"."MATNR" AS "ID_SKU_ORIGEN",
  "STM_VBRP"."ARKTX" AS "NOM_SKU",
  "STM_VBRP"."MATKL" AS "ID_GRUPO_ARTICULOS",
  "STG_MARA"."MTART" AS "ID_TIPO_MATERIAL",
  "STM_VBRP"."FKIMG" AS "CANTIDAD_FACTURADA",
  "STM_VBRP"."VRKME" AS "UNIDAD_FACTURADA",
  "STM_VBRP"."UMVKZ" AS "FC_NUMERADOR",
  "STM_VBRP"."UMVKN" AS "FC_DENOMINADOR",
  "STM_VBRP"."MEINS" AS "UNIDAD_BASE",
  "STM_VBRP"."FKLMG" AS "CANTIDAD_UNIDAD_BASE",
  "STM_VBRP"."VOLUM" AS "VOLUMEN",
  "STM_VBRP"."VOLEH" AS "UNIDAD_VOLUMEN",
  (
    COALESCE("STM_VBRP"."FKLMG", 0) * COALESCE("SILVER_MAESTRO_PRODUCTO"."VOLUMEN_LTS_UN", 0)
  ) AS "LITROS_CALCULADOS_SNOW",
  "STM_VBRP"."NTGEW" AS "PESO_NETO",
  "STM_VBRP"."BRGEW" AS "PESO_BRUTO",
  "STM_VBRP"."GEWEI" AS "UNIDAD_PESO",
  "STM_VBRK"."WAERK" AS "MONEDA_DOCUMENTO",
  "STM_VBRP"."NETWR" AS "MONTO_NETO_DOCUMENTO",
  "STM_VBRK"."KURRF" AS "FC_MONEDA_LOCAL",
  ("STM_VBRP".NETWR * "STM_VBRK".KURRF) AS "MONTO_NETO_MONEDA_LOCAL",
  "STM_VBRP"."KZWI1" AS "MONTO_BASE1",
  ("STM_VBRP".KZWI1 + "STM_VBRK".KURRF) AS "MONTO_BASE1_MONEDA_LOCAL",
  "STM_VBRK"."ZTERM" AS "ID_CONDICION_DE_PAGO",
  "STM_VBRP"."MWSBP" AS "IMPUESTO_DETALLADO_MONEDA_DOCUMENTO",
  ("STM_VBRP".MWSBP * "STM_VBRK".KURRF) AS "IMPUESTO_DETALLADO_MONEDA_LOCAL",
  "STM_VBRP"."CMPRE" AS "PRECIO_COSTE_MONEDA_DOCUMENTO",
  ("STM_VBRP".CMPRE * "STM_VBRK".KURRF) AS "PRECIO_COSTE_MONEDA_LOCAL",
  "STM_VBRK"."KONDA" AS "ID_GRUPO_PRECIOS_CLIENTE",
  "STM_VBRK"."KDGRP" AS "ID_GRUPO_CLIENTES",
  "STM_VBRK"."PLTYP" AS "TIPO_LISTA_PRECIO",
  "STM_VBRK"."FKSTO" AS "FLAG_FACTURA_ANULADA",
  "STM_VBRK"."FKDAT" AS "FECHA_FACTURA",
  "STM_VBRP"."PRSFD" AS "PRSFD",
  TO_CHAR(
    TO_DATE("STM_VBRK"."FKDAT", 'YYYY-MM-DD'),
    'YYYYMM'
  ) AS "PERIODO",
  CAST(CURRENT_TIMESTAMP AS TIMESTAMP) AS "SYSTEM_CREATE_DATE",
  CAST(CURRENT_TIMESTAMP AS TIMESTAMP) AS "SYSTEM_UPDATE_DATE"
FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRK" "STM_VBRK"
  INNER JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRP" "STM_VBRP" ON "STM_VBRK"."VBELN" = "STM_VBRP"."VBELN"
  LEFT JOIN "DEV_SILVER_M"."COMERCIAL"."SILVER_MAESTRO_PRODUCTO" "SILVER_MAESTRO_PRODUCTO" ON "STM_VBRP"."MATNR" = "SILVER_MAESTRO_PRODUCTO"."ID_SKU_ORIGEN"
  AND CONCAT("STM_VBRK"."LAND1", '-', "STM_VBRK"."BUKRS") = "SILVER_MAESTRO_PRODUCTO"."ID_SOCIEDAD"
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STG_TVAPT" STG_TVAPT ON TRIM("STG_TVAPT"."PSTYV") = TRIM("STM_VBRP"."PSTYV")
  AND "STG_TVAPT"."SPRAS" = 'S'
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STG_MARA" STG_MARA ON "STG_MARA"."MATNR" = "STM_VBRP"."MATNR"
;
  /////////////////////////// FALICACION DE REGISTROS DE JOIN /////////////////////////////////////// 
  SELECT COUNT(*)
  FROM "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRK" "STM_VBRK"
  INNER JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_VBRP" "STM_VBRP" ON "STM_VBRK"."VBELN" = "STM_VBRP"."VBELN"
  -- 218 697 657
  LEFT JOIN "DEV_SILVER_M"."COMERCIAL"."SILVER_MAESTRO_PRODUCTO" "SILVER_MAESTRO_PRODUCTO" ON "STM_VBRP"."MATNR" = "SILVER_MAESTRO_PRODUCTO"."ID_SKU_ORIGEN"
  AND CONCAT("STM_VBRK"."LAND1", '-', "STM_VBRK"."BUKRS") = "SILVER_MAESTRO_PRODUCTO"."ID_SOCIEDAD"
  -- 218 697 657
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STG_TVAPT" STG_TVAPT ON TRIM("STG_TVAPT"."PSTYV") = TRIM("STM_VBRP"."PSTYV")
  AND "STG_TVAPT"."SPRAS" = 'S'
  -- 218 697 657
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STG_MARA" STG_MARA ON "STG_MARA"."MATNR" = "STM_VBRP"."MATNR"
  -- 218 697 657
  LEFT JOIN "DEV_BRONZE_M"."BRONZE_STAGING"."STM_ZFIT_HEAD_LIQR" STM_ZFIT_HEAD_LIQR 
    ON "STM_ZFIT_HEAD_LIQR"."VBELN_VF" = "STM_VBRK"."XBLNR" 
    AND "STM_ZFIT_HEAD_LIQR"."VBELN_VFR" = "STM_VBRK"."VBELN" 
  -- 218 697 657
